<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gabriel Sassone">

  
  
  
    
  
  <meta name="description" content="Overview In the last articles we looked at progressively building tools to move rendering code towards data.We looked on how to create a simple lexer, a simple parser and a code generator.With those we were able to create a very simple language to augment shaders.
Why that ?
There are few reasons:
 Shader languages misses any way of linking multiple programs Shader languages misses any way to define render states CGFX and Microsoft FX are mostly dead Ability to use ANY shader language - and just add the infrastructure Ability to generate permutations without manually creating them  Hydra FX aims to add all the missing features and becoming just an augmentation to ANY shader language.">

  
  <link rel="alternate" hreflang="en-us" href="https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/">

  


  

  
  
  
  <meta name="theme-color" content="hsl(339, 90%, 68%)">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/ocean.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/ocean.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.3c1397731166a1801db28da8c18494e1.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/">

  
  
  
  
    
    
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@GabrielSassone">
  <meta property="twitter:creator" content="@GabrielSassone">
  
  <meta property="og:site_name" content="Gabriel&#39;s Virtual Tavern">
  <meta property="og:url" content="https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/">
  <meta property="og:title" content="Augmenting shader languages for modern rendering APIs | Gabriel&#39;s Virtual Tavern">
  <meta property="og:description" content="Overview In the last articles we looked at progressively building tools to move rendering code towards data.We looked on how to create a simple lexer, a simple parser and a code generator.With those we were able to create a very simple language to augment shaders.
Why that ?
There are few reasons:
 Shader languages misses any way of linking multiple programs Shader languages misses any way to define render states CGFX and Microsoft FX are mostly dead Ability to use ANY shader language - and just add the infrastructure Ability to generate permutations without manually creating them  Hydra FX aims to add all the missing features and becoming just an augmentation to ANY shader language."><meta property="og:image" content="https://jorenjoestar.github.io/img/icon-192.png">
  <meta property="twitter:image" content="https://jorenjoestar.github.io/img/icon-192.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-03-16T12:11:37-04:00">
  
  <meta property="article:modified_time" content="2020-03-16T12:11:37-04:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "hsl(339, 90%, 68%)",
          "text": "#fff"
        },
        "button": {
          "background": "#fff",
          "text": "hsl(339, 90%, 68%)"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>



  





  <title>Augmenting shader languages for modern rendering APIs | Gabriel&#39;s Virtual Tavern</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="dark">

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Gabriel&#39;s Virtual Tavern</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Augmenting shader languages for modern rendering APIs</h1>

  

  
    



<meta content="2020-03-16 12:11:37 -0400 -0400" itemprop="datePublished">
<meta content="2020-03-16 12:11:37 -0400 -0400" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    <time>2020-03-16</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    15 min read
  </span>
  

  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    <a href="/categories/coding/">coding</a></span>
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/&amp;text=Augmenting%20shader%20languages%20for%20modern%20rendering%20APIs" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/&amp;t=Augmenting%20shader%20languages%20for%20modern%20rendering%20APIs" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Augmenting%20shader%20languages%20for%20modern%20rendering%20APIs&amp;body=https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/&amp;title=Augmenting%20shader%20languages%20for%20modern%20rendering%20APIs" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://reddit.com/submit?url=https://jorenjoestar.github.io/post/shader_augment_for_pipelines/shader_augment_for_pipelines/&amp;title=Augmenting%20shader%20languages%20for%20modern%20rendering%20APIs" target="_blank" rel="noopener" class="share-btn-reddit">
          <i class="fab fa-reddit-alien"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <h1 id="overview">Overview</h1>
<p>In the last articles we looked at progressively building tools to move rendering code towards data.<!-- raw HTML omitted -->
We looked on how to create a simple <strong>lexer</strong>, a simple <strong>parser</strong> and a <strong>code generator</strong>.<!-- raw HTML omitted -->
With those we were able to create a very simple language to <strong>augment</strong> shaders.</p>
<p>Why that ?</p>
<p>There are few reasons:</p>
<ol>
<li>Shader languages misses any way of linking multiple programs</li>
<li>Shader languages misses any way to define render states</li>
<li>CGFX and Microsoft FX are mostly dead</li>
<li>Ability to use ANY shader language - and just add the infrastructure</li>
<li>Ability to generate permutations without manually creating them</li>
</ol>
<p>Hydra FX aims to add all the missing features and becoming just an augmentation to ANY shader language.</p>
<p>There is also a fundamental reason for me:</p>
<blockquote>
<p>Define all the rendering informations needed as soon as possible!</p>
</blockquote>
<p>With this reason then defining everything inside an HFX file, with the possibility of overriding some properties, it is paramount.</p>
<p>This is by far a new concept, and with the newer Graphics APIs (Vulkan and D3D12) it is becoming more and more of a need.<!-- raw HTML omitted --></p>
<p>In this article we will see how we have all those features and add the missing ones. I will try to define everything in a more API-Independent way, so it can be adapted to any engine needs.</p>
<h1 id="why-we-need-shader-augmentation">Why we need shader augmentation</h1>
<p>The augmentation that I have in mind is needed for different reasons, not only if you are targeting the newer APIs.<!-- raw HTML omitted -->
Some of the reasons are the following:</p>
<ol>
<li>Write the NECESSARY code. Nothing more.</li>
<li>Logically group shaders in the same file.</li>
<li>Describe a priori all the STATIC parts of rendering.</li>
<li>Being more data driven, improve iteration time.</li>
<li>Being more data driven, encourage rendering experimentation.</li>
<li>Easiness of debugging.</li>
<li>Encourages less hardcoded data.</li>
</ol>
<h2 id="write-the-necessary-code-nothing-more">Write the NECESSARY code. Nothing more.</h2>
<p>As I wrote in previous articles writing code is our biggest power and liability.<!-- raw HTML omitted -->
Wasting time writing useless code is like slowly typing with one finger, without any clue of a design nor knowledge of the subject.<!-- raw HTML omitted -->
Of course this is very personal, but any time I have to reiterate some steps (in anything in my life) for no purpose but bad-design/bad-architecture/technical-debt it really makes me feel bad.<!-- raw HTML omitted -->
Again, it is like playing Diablo and clicking all the time to attack, instead of knowing that you can hold the mouse button!</p>
<p>Finally to the topic: shader augmentation means moving to data what many times is expressed in code.<!-- raw HTML omitted -->
We can both have a data-driven rendering, or even generate code for us, or a combination of both.<!-- raw HTML omitted -->
There is not right or wrong, and this will change in the future!<!-- raw HTML omitted -->
The best solution is the one that solves your (incredibly well described) problem.</p>
<p>Adding render states, vertex inputs, render graph informations let a simple text file to find its space into your awesome rendering quite easily.</p>
<h2 id="logically-group-shaders-in-the-same-file">Logically group shaders in the same file.</h2>
<p>Having to write separated files it can be ok, but many times having everything in one file (well divided) will be easier to logically connects the shader themselves.<!-- raw HTML omitted -->
Sometimes you can get lost into the combination of shaders quite easily.<!-- raw HTML omitted -->
And anyway you NEED to define which shaders are used together since the dawn of time.</p>
<p>So put them into the same file!</p>
<h2 id="describe-a-priori-all-the-static-parts-of-rendering">Describe a priori all the STATIC parts of rendering.</h2>
<p>Knowing all the static parts of rendering can lead to offline analysis and build, statistics, and all kind of things you can think of.<!-- raw HTML omitted -->
It also serves to really have knowledge of the combinational explosion of rendering <strong>before</strong> it arrives in your beloved renderer!<!-- raw HTML omitted -->
Sometimes you can group shaders together and improve speed and usability by just analysing how <strong>similar</strong> some shaders are.</p>
<h2 id="being-more-data-driven-improve-iteration-time">Being more data driven, improve iteration time.</h2>
<p>If you think of reloading assets, then a shader reload will also load all the render stage associated.<!-- raw HTML omitted -->
If you want to bring it a step further, adding/removing passes, changing were in the <em>render graph</em> the shaders are used can be an incredible tool to quickly prototype, optimize, develop ideas.</p>
<h2 id="being-more-data-driven-encourage-rendering-experimentation">Being more data driven, encourage rendering experimentation.</h2>
<p>You can also add some non-coding tools to augment a shader with all those data.<!-- raw HTML omitted -->
And again, defining this in data let&rsquo;s you check relationship with the rest of the renderer more easily.</p>
<h2 id="easiness-of-debugging">Easiness of debugging.</h2>
<p>Data-drivenness means that data is always available.<!-- raw HTML omitted -->
In the example I am adding here, you can see how useful can be to even have a simple ImGui debug of a HFX file.<!-- raw HTML omitted -->
Bring that to a realtime renderer, and you can quickly debug rendering problems without having to use external tools like Pix, RenderDoc and such. These are wonderful tools, but I always love to have a defense before arriving there.</p>
<p>An example is to debug on someone&rsquo;s machine that does not have installed those tools.</p>
<p>Same can be applied to performances, to quickly check performances in realtime.</p>
<p>Tooling is essential to any developer, and should be developed with the technology itself.</p>
<h2 id="encourages-less-hardcoded-data">Encourages less hardcoded data.</h2>
<p>Nothing wrong to hardcoding data, and many times is necessary and useful.<!-- raw HTML omitted -->
But the question is: <strong>when</strong> is necessary ?</p>
<p>Having a common data format gives you the tools (see previous point) to analyze, compared to hardcoded.</p>
<h1 id="shader-augmentations">Shader Augmentations</h1>
<p>We will take a HFX shader and will see all the augmentations.<!-- raw HTML omitted -->
This is used in the <a href="https://jorenjoestar.github.io/post/data_driven_rendering_pipeline/">Render Pipeline Article</a> and renders the GLTF assets:</p>
<pre tabindex="0"><code>shader PBR {

    properties {
        albedo_texture(&quot;Albedo&quot;, 2D) = &quot;&quot;
        normals_texture(&quot;Normals&quot;, 2D) = &quot;&quot;
        metal_roughness_texture(&quot;MetalRoughness&quot;, 2D) = &quot;&quot;
        emissive_texture(&quot;Emissive&quot;, 2D) = &quot;&quot;
        occlusion_texture(&quot;Occlusion&quot;, 2D) = &quot;&quot;
        scale(&quot;Scale&quot;, Float) = 16.0
    }

    layout {
        vertex main3D {
            binding 0 16 vertex
            attribute float3 Position 0 0 0
            attribute ubyte4n Color 0 1 12
        }

        vertex main3DPosition {
            binding 0 12 vertex
            attribute float3 Position 0 0 0
        }

        vertex main3DPositionNormal {
            binding 0 12 vertex
            binding 1 12 vertex
            binding 3 64 instance
            attribute float3 Position 0 0 0
            attribute float3 Normal 1 1 0
            attribute float4 InstanceTransform 3 3 0
            attribute float4 InstanceTransform 3 4 16
            attribute float4 InstanceTransform 3 5 32
            attribute float4 InstanceTransform 3 6 48
        }

        vertex gbuffer {
            binding 0 12 vertex
            binding 1 12 vertex
            binding 2 8 vertex
            binding 3 64 instance
            attribute float3 Position 0 0 0
            attribute float3 Normal 1 1 0
            attribute float2 UV 2 2 0
            attribute float4 InstanceTransform 3 3 0
            attribute float4 InstanceTransform 3 4 16
            attribute float4 InstanceTransform 3 5 32
            attribute float4 InstanceTransform 3 6 48
        }

        list gbuffer {
            cbuffer ViewConstants ViewConstants;

            texture2D albedo;
            texture2D normals;
            texture2D metalRoughness;
            texture2D emissive;
            texture2D occlusion;

            sampler2D linear_sampler
        }
    }

    sampler_states {
        state linear_sampler {
            Filter MinMagMipLinear
            AddressU Clamp
            AddressV Clamp
        }
    }

    render_states {
        state main {
            Cull Back
            ZTest LEqual
            ZWrite On
        }

        state linesZTest {
            Cull None
            ZTest LEqual
            ZWrite Off
            BlendMode Alpha
        }
    }

    glsl GBuffer_V {

        #pragma include &quot;Platform.h&quot;

        layout (location = 0) in vec3 Position;
        layout (location = 1) in vec3 Normal;
        layout (location = 2) in vec2 UV;
        layout (location = 3) in mat4 instanceTransform;

        layout (std140, binding=0) uniform ViewConstants {
            mat4                    view_projection_matrix;
            mat4                    projection_matrix;
            vec4                    resolution;
        };

        out vec3 vertexNormal;
        out vec2 uv;
        out vec3 worldPosition;

        void main()
        {
            vertexNormal = (inverse(transpose((instanceTransform))) * vec4(Normal,0)).rgb;
            uv = UV;

            vec4 world_pos = instanceTransform * vec4(Position.xyz, 1.0f);
            worldPosition = world_pos.xyz;
            gl_Position = view_projection_matrix * world_pos;
        }
    }

    glsl GBuffer_F {

        #pragma include &quot;Platform.h&quot;
    
        layout (location = 0) out vec4 Out_Color;
        layout (location = 1) out vec4 Out_Normals;
        layout (location = 2) out vec4 Out_Properties0;
        //layout (location = 3) out vec4 Out_WorldPosition;

        layout(binding=0) uniform sampler2D albedo;
        layout(binding=1) uniform sampler2D normals;
        layout(binding=2) uniform sampler2D metalRoughness;
        layout(binding=3) uniform sampler2D emissive;
        layout(binding=4) uniform sampler2D occlusion;

        in vec3 vertexNormal;
        in vec2 uv;
        in vec3 worldPosition;

        void generate_TB_basis( out vec3 vT, out vec3 vB, vec2 texST, vec3 base_normal, vec3 sigma_x, vec3 sigma_y, float flip_sign )
        {
            vec2 dSTdx = dFdxFine ( texST ) , dSTdy = dFdyFine ( texST ) ;
            float det = dot ( dSTdx , vec2 ( dSTdy .y ,- dSTdy .x ));
            float sign_det = det &lt;0 ? -1 : 1;

            // invC0 represents ( dXds , dYds ) ; but we don ’t divide by
            // determinant ( scale by sign instead )
            vec2 invC0 = sign_det * vec2 ( dSTdy .y , - dSTdx .y );

            vT = sigma_x * invC0 .x + sigma_y * invC0 .y;
            if( abs ( det ) &gt; 0.0)
                vT = normalize ( vT );

            vB = ( sign_det * flip_sign ) * cross ( base_normal , vT );
        }

        void main()
        {
            // Calculate gradient base:
            vec3 base_normal = normalize(vertexNormal);

            vec3 position_derivate_x = dFdxFine( worldPosition );
            vec3 position_derivate_y = dFdyFine( worldPosition );

            vec3 sigma_x = position_derivate_x - dot( position_derivate_x, base_normal ) * base_normal;
            vec3 sigma_y = position_derivate_y - dot( position_derivate_y, base_normal ) * base_normal;
            float flip_sign = dot ( position_derivate_y, cross ( base_normal, position_derivate_x )) &lt; 0 ? -1 : 1;

            vec3 tangent, bitangent;
            generate_TB_basis( tangent, bitangent, uv.xy, base_normal, sigma_x, sigma_y, flip_sign );

            vec3 tangent_normal = texture(normals, uv.xy).xyz * 2 - 1;

            vec3 normal = tangent * tangent_normal.x + bitangent * tangent_normal.y + base_normal * tangent_normal.z;
            normal = normalize(normal);

            vec3 emissive_color = texture(emissive, uv.xy).rgb;

            //Out_Normals = vec4(vertexNormal, 1);
            //Out_Normals = vec4(tangent_normal * 0.5 + 0.5, 1);
            Out_Normals = vec4(normal, emissive_color.r);

            vec3 color = texture(albedo, uv.xy).xyz;
            float occlusion = texture(occlusion, uv.xy).r;
            Out_Color = vec4(color, occlusion);

            // G = Rougthness, B = Metalness
            vec2 roughness_metal = texture(metalRoughness, uv.xy).yz;
            Out_Properties0 = vec4(roughness_metal.xy, emissive_color.gb);

            // TODO: remove! This is to test world space reconstruction!
            //Out_WorldPosition = vec4(worldPosition, 1);
        }
    }

    glsl PositionOnly {

        #pragma include &quot;Platform.h&quot;

        #if defined VERTEX

        layout (location = 0) in vec3 Position;

        uniform ViewConstants { 
            mat4                    view_projection_matrix;
            mat4                    projection_matrix;
            vec4                    resolution;
        };

        void main()
        {
            gl_Position = view_projection_matrix * vec4(Position.xyz, 1.0f);
        }
        out vec4 vTexCoord;

        #endif // VERTEX

        #if defined FRAGMENT

        layout (location = 0) out vec4 Out_Color;
        
        void main()
        {
            Out_Color = vec4(1,1,1,1);
        }
        #endif // FRAGMENT
    }

    glsl PositionNormals {

        #pragma include &quot;Platform.h&quot;

        #if defined VERTEX

        layout (location = 0) in vec3 Position;
        layout (location = 1) in vec3 Normal;
        layout (location = 3) in mat4 instanceTransform;

        layout (std140, binding=0) uniform ViewConstants { 
            mat4                    view_projection_matrix;
            mat4                    projection_matrix;
            vec4                    resolution;
        };

        out vec3 vertexNormal;

        void main()
        {
            vertexNormal = Normal;
            gl_Position = view_projection_matrix * instanceTransform * vec4(Position.xyz, 1.0f);
        }
        

        #endif // VERTEX

        #if defined FRAGMENT

        layout (location = 0) out vec4 Out_Color;
        layout (location = 1) out vec4 Out_Normals;
        in vec3 vertexNormal;
        
        void main()
        {
            Out_Normals = vec4(vertexNormal * 0.5 + 0.5, 1);

            vec3 L = vec3(-0.7, 0.7, 0 );
            float lambert_diffuse = max(0, dot(vertexNormal, L));
            Out_Color = vec4(lambert_diffuse.xxx, 1);
        }
        #endif // FRAGMENT
    }

    pass GBuffer {
        resources = gbuffer
        render_states = main
        vertex_layout = gbuffer
        vertex = GBuffer_V
        fragment = GBuffer_F
    }

    pass PositionN {
        render_states = main
        vertex_layout = main3DPositionNormal
        vertex = PositionNormals
        fragment = PositionNormals
    }

    pass PositionOnly {
        render_states = main
        vertex_layout = main3DPosition
        vertex = PositionOnly
        fragment = PositionOnly
    }
}
</code></pre><h2 id="1-linking-multiple-programs">1: Linking Multiple Programs</h2>
<p>This is a pretty simple task, and the first one to be tackled.<!-- raw HTML omitted --></p>
<p>In Vulkan all the Pipelines need all the shader used at creation, using an array of <a href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VkPipelineShaderStageCreateInfo.html">VkPipelineStageCreationInfo</a> for graphics, compute and ray-tracing.</p>
<p>In D3D12, you have the <a href="https://docs.microsoft.com/en-us/windows/win32/api/d3d12/ns-d3d12-d3d12_shader_bytecode">ShaderBytecode</a> used in the pipelines, but not as arrays (just member of the various creation structs).</p>
<p>From a functionality perspective, they are EQUAL. It makes sense - a <strong>Pipeline</strong> is the description of all the static part of a GPU pipeline, and shaders are amongst the most important part of it.</p>
<p>You can see it in the &lsquo;pass&rsquo; section of the HFX file:</p>
<pre tabindex="0"><code>pass PositionOnly {
    vertex = PositionOnly
    fragment = PositionOnly
    ...
}
</code></pre><p>For a compute pipeline is even simpler, and dispatch size can be added as well:</p>
<pre tabindex="0"><code>pass DeferredCompute {
    compute = DeferredCompute
    dispatch = 32, 32, 1
    ...
}
</code></pre><p>Even just with something like this it is easy to organize different shaders.</p>
<h2 id="2-define-render-states">2: Define Render States</h2>
<p>Following the previous point, Pipelines need also (almost) all the render states (depth/stencil, alpha, raster, &hellip;) to be defined.<!-- raw HTML omitted -->
This was one of the main features of CGFX and Microsoft&rsquo;s FX - and still now is incredibly useful.<!-- raw HTML omitted -->
Unity&rsquo;s ShaderLab also incorporates render states.</p>
<p>I decided to separate render states on their own group:</p>
<pre tabindex="0"><code>render_states {
    state main {
        Cull Back
        ZTest LEqual
        ZWrite On
    }

    state linesZTest {
        Cull None
        ZTest LEqual
        ZWrite Off
        BlendMode Alpha
    }
}
</code></pre><p>Here two different render states are defined.<!-- raw HTML omitted -->
In this case a render states defines depth/stencil, blend and rasterization.</p>
<p>A great addition to that is to add the possibility of inherit/override render states.<!-- raw HTML omitted -->
For example in a Transparent pass, the blend state could be defined in the Render Pass data, and be inherited explicitly here.</p>
<p>Also very important is the definition of <strong>input assembly</strong> - how the vertices are fed into the <em>vertex program</em>:</p>
<pre tabindex="0"><code>layout {
    vertex main3D {
        binding 0 16 vertex
        attribute float3 Position 0 0 0
        attribute ubyte4n Color 0 1 12
    }

    vertex main3DPosition {
        binding 0 12 vertex
        attribute float3 Position 0 0 0
    }

    vertex main3DPositionNormal {
        binding 0 12 vertex
        binding 1 12 vertex
        binding 3 64 instance
        attribute float3 Position 0 0 0
        attribute float3 Normal 1 1 0
        attribute float4 InstanceTransform 3 3 0
        attribute float4 InstanceTransform 3 4 16
        attribute float4 InstanceTransform 3 5 32
        attribute float4 InstanceTransform 3 6 48
    }

    vertex gbuffer {
        binding 0 12 vertex
        binding 1 12 vertex
        binding 2 8 vertex
        binding 3 64 instance
        attribute float3 Position 0 0 0
        attribute float3 Normal 1 1 0
        attribute float2 UV 2 2 0
        attribute float4 InstanceTransform 3 3 0
        attribute float4 InstanceTransform 3 4 16
        attribute float4 InstanceTransform 3 5 32
        attribute float4 InstanceTransform 3 6 48
    }
}
</code></pre><p>Here we can see some instancing use case, just to show the flexibility of writing this code.<!-- raw HTML omitted -->
The bytes offset could be removed as well.</p>
<h2 id="3-use-any-shader-language">3: Use ANY Shader Language</h2>
<p>The best way to diffuse these augmentation is to change the less possible the shader languate itself.<!-- raw HTML omitted -->
This is because you want to be portable, and when having different platform it can be paramount even to define shaders with different languages into the same file, and switch based on platforms.<!-- raw HTML omitted -->
This is becoming less and less of a need (see HLSL working on Vulkan) but there could be some special cases.<!-- raw HTML omitted -->
Would it be great to fix those special cases by writing platform specific shader fragments without any of your internal rendering code changing ?</p>
<p>The choise here is to use a keyword to identify the type of language and then simply write the code in that language.<!-- raw HTML omitted -->
This is <em>ideal</em> to also incorporate code from previous codebases with a small amount of work.</p>
<p>Let&rsquo;s look at the GBuffer Vertex GLSL code:</p>
<pre tabindex="0"><code>glsl GBuffer_V {

    #pragma include &quot;Platform.h&quot;

    layout (location = 0) in vec3 Position;
    layout (location = 1) in vec3 Normal;
    layout (location = 2) in vec2 UV;
    layout (location = 3) in mat4 instanceTransform;

    layout (std140, binding=0) uniform ViewConstants {
        mat4                    view_projection_matrix;
        mat4                    projection_matrix;
        vec4                    resolution;
    };

    out vec3 vertexNormal;
    out vec2 uv;
    out vec3 worldPosition;

    void main()
    {
        vertexNormal = (inverse(transpose((instanceTransform))) * vec4(Normal,0)).rgb;
        uv = UV;

        vec4 world_pos = instanceTransform * vec4(Position.xyz, 1.0f);
        worldPosition = world_pos.xyz;
        gl_Position = view_projection_matrix * world_pos;
    }
}
</code></pre><p>The only modification I did, and it is sadly necessary in GLSL, is to add the &lsquo;#pragma include&rsquo; custom parsing to add the include in the HFX compiler.</p>
<h2 id="4-resource-layouts-as-first-citizens">4: Resource Layouts as First Citizens</h2>
<p>A new addition of the new APIs, resource layouts are another great factor to take care of.<!-- raw HTML omitted -->
Architecturally they can be implemented in different ways, but I like the idea of having them &lsquo;in your face&rsquo; since the beginning!</p>
<p>In the <em>layout</em> section, you can define resources like this:</p>
<pre tabindex="0"><code>list gbuffer {
    cbuffer ViewConstants ViewConstants;

    texture2D albedo;
    texture2D normals;
    texture2D metalRoughness;
    texture2D emissive;
    texture2D occlusion;

    sampler2D linear_sampler
}
</code></pre><p>The name will be used in the pass section to define which resource list is used.<!-- raw HTML omitted -->
There can be multiple resource lists, normally they should be grouped per frequency (most frequent changes to least frequent ones) and can be separated by a comma for example.<!-- raw HTML omitted --></p>
<p>A small addition is to use externally specified resource list and code, like for <strong>starnest.hfx</strong>:</p>
<pre tabindex="0"><code>pass main {
	...
	resources = &quot;ShaderToy.Main&quot;	
}
</code></pre><p>This means that the pass named &lsquo;main&rsquo; will simply use the resources defined in &lsquo;shadertoy.hfx&rsquo; - resource list called main.</p>
<h2 id="5-permutations">5: Permutations</h2>
<p>This is the most tedious of the tasks, and also one of the most dangerous.<!-- raw HTML omitted -->
Permutations explosion is a well known problem, and there are different ways of tackling this. If you don&rsquo;t have a shader augmentation a good option is to write some scripts to help with generating the code.<!-- raw HTML omitted --></p>
<p>Otherwise if you have a shader augmentation and you define a &lsquo;shader state&rsquo;, you can define some &lsquo;permutation flags&rsquo;, and just add the defines when you compile shaders. Even in GLSL, you can do some easy string concatenation to add those defines, or use tools like GLSLang + SpirV to help.</p>
<p>This becomes a cartesian product of all the <em>permutations/options groups</em> and again can lead to a lot of created shader.<!-- raw HTML omitted -->
I am still investigating the best approach and I will update this article with the results, because I want to include them into HFX but avoid that to become a huge file - and worst to include unused permutations.</p>
<p>So stay tuned as I will update this article with the solution I find!</p>
<h2 id="6-c-generated-helpers">6: C++ Generated Helpers</h2>
<p>As finishing touch, there are some informations that can be exposed in a c++ file.
&hellip;</p>
<h1 id="included-code-shader-augmentation">Included code: &lsquo;Shader Augmentation&rsquo;</h1>
<p>The included code has a small application to compile and inspect HFX files.
&hellip;</p>
<h1 id="conclusions">Conclusions</h1>
<p>I tried to explain the reasons of the different <strong>shader augmentations</strong> and trying to focus more on the importance of not trying to create a new shading language, but instead empowering it with new informations.</p>
<p>I can&rsquo;t stress enough how important is to me to have an abstraction that is slightly on top of current shaders API - and create other systems to hide the complexities if needed.</p>
<p>With HFX, I would like to <em>expand</em> any language by adding all those features.<!-- raw HTML omitted -->
I wish this could become a used tool by many in their project, and really wish it will be the initial spark.</p>
<p>Next in line is a revisiting of higher level of rendering, to arrive to explore different rendering techniques with the easiness that the data-driven approach should give.</p>
<p>As always please comment, give me feedback, share and enjoy!</p>
<p>Thanks for reading!
Gabriel</p>

    </div>

    


    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/shaders/">shaders</a>
  
</div>



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hud465246e9f9c1d8ddb2723f337b10400_187705_250x250_fill_q90_lanczos_center.jpg" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://jorenjoestar.github.io/">Gabriel Sassone</a></h5>
      <h6 class="card-subtitle">Principal Rendering/Engine Programmer</h6>
      
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/GabrielSassone" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://bsky.app/profile/gabrielsassone.bsky.social" target="_blank" rel="noopener">
              <i class="fab fa-mastodon"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://mastodon.gamedev.place/@GabrielSassone" target="_blank" rel="noopener">
              <i class="fab fa-mastodon"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/JorenJoestar" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/writing_shader_effect_language_3/">Writing a Shader Effect Language Part 3: Materials</a></li>
          
          <li><a href="/post/writing_shader_effect_language_2/">Writing a Shader Effect Language Part 2</a></li>
          
          <li><a href="/post/writing_shader_effect_language_1/">Writing a Shader Effect Language Part 1</a></li>
          
        </ul>
      </div>
      
    

    

    


  </div>
</article>

      

    
    
    
    <script src="/js/mathjax-config.js"></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js" integrity="sha256-0w92bcB21IY5+rGI84MGj52jNfHNbXVeQLrZ0CGdjNY=" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cpp.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.5fde6b67896bd1833c4041260289785f.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
