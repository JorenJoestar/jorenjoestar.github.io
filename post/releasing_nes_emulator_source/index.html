<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.4.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gabriel Sassone">

  
  
  
    
  
  <meta name="description" content="Legend of Zelda emulated plus debugging windows.   Hello everyone!
Today I release the source code of my bare-bone NES emulator, written in C&#43;&#43;.
I had the idea to write an emulator of one of my favorite console (after the SNES) years ago, and started in 2015 to write the first code (actually in 2008, but it was too daunting even to start). Then I concentrated on my other big project (still ongoing) and left all the NES code on a side.">

  
  <link rel="alternate" hreflang="en-us" href="https://jorenjoestar.github.io/post/releasing_nes_emulator_source/">

  


  

  
  
  
  <meta name="theme-color" content="hsl(339, 90%, 68%)">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/ocean.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/ocean.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.ad3806488b87675a634db142f24b6938.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://jorenjoestar.github.io/post/releasing_nes_emulator_source/">

  
  
  
  
    
    
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@GabrielSassone">
  <meta property="twitter:creator" content="@GabrielSassone">
  
  <meta property="og:site_name" content="Joren&#39;s">
  <meta property="og:url" content="https://jorenjoestar.github.io/post/releasing_nes_emulator_source/">
  <meta property="og:title" content="Releasing NES Emulator Source | Joren&#39;s">
  <meta property="og:description" content="Legend of Zelda emulated plus debugging windows.   Hello everyone!
Today I release the source code of my bare-bone NES emulator, written in C&#43;&#43;.
I had the idea to write an emulator of one of my favorite console (after the SNES) years ago, and started in 2015 to write the first code (actually in 2008, but it was too daunting even to start). Then I concentrated on my other big project (still ongoing) and left all the NES code on a side."><meta property="og:image" content="https://jorenjoestar.github.io/img/icon-192.png">
  <meta property="twitter:image" content="https://jorenjoestar.github.io/img/icon-192.png"><meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-07-23T02:04:50-04:00">
  
  <meta property="article:modified_time" content="2019-07-23T02:04:50-04:00">
  

  


  





  <title>Releasing NES Emulator Source | Joren&#39;s</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="dark">

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  
<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0 compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Joren&#39;s</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


  <article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Releasing NES Emulator Source</h1>

  

  
    



<meta content="2019-07-23 02:04:50 -0400 EDT" itemprop="datePublished">
<meta content="2019-07-23 02:04:50 -0400 EDT" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    <time>2019-07-23</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  

  
  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://jorenjoestar.github.io/post/releasing_nes_emulator_source/&amp;text=Releasing%20NES%20Emulator%20Source" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://jorenjoestar.github.io/post/releasing_nes_emulator_source/&amp;t=Releasing%20NES%20Emulator%20Source" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook-f"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Releasing%20NES%20Emulator%20Source&amp;body=https://jorenjoestar.github.io/post/releasing_nes_emulator_source/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://jorenjoestar.github.io/post/releasing_nes_emulator_source/&amp;title=Releasing%20NES%20Emulator%20Source" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://reddit.com/submit?url=https://jorenjoestar.github.io/post/releasing_nes_emulator_source/&amp;title=Releasing%20NES%20Emulator%20Source" target="_blank" rel="noopener" class="share-btn-reddit">
          <i class="fab fa-reddit-alien"></i>
        </a>
      </li>
    
  </ul>
</div>


  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      





<figure>

  <a data-fancybox="" href="ZeldaNESEmulated.png" >

<img src="ZeldaNESEmulated.png" >
</a>


<figcaption data-pre="Figure " data-post=":" >
  <h4>Legend of Zelda emulated plus debugging windows.</h4>
  
</figcaption>

</figure>

<p>Hello everyone!</p>
<p>Today I release the source code of my bare-bone NES emulator, written in C++.</p>
<p>I had the idea to write an emulator of one of my favorite console (after the SNES) years ago, and started in 2015 to write the first code (actually in 2008, but it was too daunting even to start).
Then I concentrated on my other big project (still ongoing) and left all the NES code on a side.
Years passed and finally last winter I decided to give it a go to arrive at a ‘usable’ emulator level and release the source code.</p>
<p>Here it is!
(<a href="https://github.com/JorenJoestar/HydraNes">https://github.com/JorenJoestar/HydraNes</a>)</p>
<h2 id="motivation">Motivation</h2>
<p>Main motivation both to write and to share this code is <em>knowledge</em>.</p>
<p>I shamelessly wrote bad code just with the purpose of seeing something on screen as fast as I could.
And I am very honest about that: not happy for the form, but happy for the knowledge I gained!
Also, I think that this code is compact enough to be followed and to understand the basics of NES emulation coding.</p>
<h2 id="the-code">The code</h2>
<p>The <strong>NES code</strong> lives in the Nes.h/.cpp pair of files.
The <strong>APU</strong> is implemented using <strong>Blargg’s implementation</strong>: when I’ll have other time I will attemp to finish my own implementation, but for now it is ok like that.</p>
<p>The flow is the following:</p>
<ul>
<li>NES is initialized</li>
<li>After loading a rom (from the Cartridge window) the mapper will be selected and memory copied to local buffers.</li>
<li>CPU starts its continuous emulation.</li>
<li>CPU will execute until a frame is produced. This is checked by the PPU frame changing.</li>
<li>PPU execution is bound to memory accesses, both read and write.</li>
<li>Each CPU memory access corresponds to 3 PPU cycles (in NTSC, the only region emulated).</li>
<li>After the frame is ended the APU emulation is advanced.</li>
</ul>
<h2 id="interesting-spots">Interesting spots</h2>
<p>There are different areas of the code that are interesting, but I would like to highlight some.</p>
<h3 id="cpustep">Cpu::Step()</h3>
<p>This is where all the <strong>CPU</strong> instructions are executed. I opted for a macro based approach instead of tables of function pointers.</p>
<p>For each cpu cycle:</p>
<ul>
<li>Fetch the instruction opcode</li>
<li>Calculate the operand address (called ‘effectiveAddress’)</li>
<li>Execute the operation</li>
</ul>
<p>All the operations and addressing modes are in the Nes.h file.
<em>Addressing modes</em> are the way the NES gets its operand for each operation.
Operations are the instruction themselves — using those operands.</p>
<h3 id="ppustep">Ppu::Step()</h3>
<p>PPU by itself is the most difficult part to emulate (APU is easier on the channels, but harder on the mix and signal generation!).</p>
<p>I will make a post about that soon, but in the meantime here the code is and implements the behaviours described here:</p>
<p><a href="https://wiki.nesdev.com/w/index.php/File:Ntsc_timing.png">https://wiki.nesdev.com/w/index.php/File:Ntsc_timing.png</a></p>
<p>The <strong>PPU</strong> draws in tiles of <strong>8x8 pixels</strong>, so for each pixels created on the screen there will be a gathering of all the data necessary to calculate the final color.</p>
<p>The rendering is divided in <strong>background</strong> and <strong>sprites</strong>.</p>
<p>Background is just <strong>8x8 pixel per tile</strong> choosen from the <strong>nametable</strong> (a screen table of which tiles are visible) and <strong>sprites</strong> are either 8x8 or 8x16 rectangles coming from a different memory area (uploaded using <strong>DMA</strong>).</p>
<p>There are many quirks and uniqueness about the <strong>PPU</strong>, like the <strong>pattern table</strong> (a 16x16 grid storing the higher 2 bits of all the underlying background pixels), or the vertical blank period, or the open bus.</p>
<h3 id="ppudrawpixel">Ppu::DrawPixel()</h3>
<p>The color of a pixel comes from one of the 16 entries of the <strong>palette VRAM</strong>, and to do so 4 bits must be calculated for background and for sprites.</p>
<p>For background tiles, 2 pixels comes from the ‘texture’ (<strong>CHR-ROM</strong>) and 2 from the attribute table.
<!-- raw HTML omitted -->Sprites contains all those informations together.</p>
<p>The output is a silly <em>SSBO</em> that contains RGBA colors to be used in a compute shader that outputs to the screen.</p>
<h3 id="cpureadwrite-ppureadwrite">CpuRead/Write, PpuRead/Write</h3>
<p>All those methods are essential because the NES uses memory mapping i/o to access the different hardware.</p>
<p>For example the <strong>PPU</strong> access the cartridge through the mapper in the memory controller to read drawing informations, the <strong>CPU</strong> writes to the <strong>PPU</strong> using address $2007, etc.</p>
<h2 id="ending-notes">Ending notes</h2>
<p>I will prepare more detailed posts about the <strong>NES architecture and emulation</strong>, even though there are still some concepts that are not clear to me and require a deeper investigation.</p>
<p>So far this is the most <em>satisfactory</em> personal project I’ve done, and one of the few that arrived at a usable level.</p>
<p>In the future I want to improve this emulator and use the knowledge to explore the writing of a SNES emulator!</p>
<p>Any question or comment please let me know!</p>
<p>Gabriel</p>

    </div>

    


    



    
      








  





  
  
  
    
  
  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hu45846e015095c9654b2fb671ea5d5811_27176_250x250_fill_q90_lanczos_center.jpg" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="https://jorenjoestar.github.io/">Gabriel Sassone</a></h5>
      <h6 class="card-subtitle">Senior Rendering/Engine Programmer</h6>
      
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/GabrielSassone" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://github.com/JorenJoestar" target="_blank" rel="noopener">
              <i class="fab fa-github"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

      

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cpp.min.js"></script>
        
      

      
      
    

    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.16bbb3750feb7244c9bc409a5a4fe678.js"></script>

    






  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
